<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Физическая Песочница</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://yandex.ru/games/sdk/v2"></script>
    <style>
        :root {
            --toolbar-height: 56px;
            --toolbar-bg: #2d2d2d;
            --button-bg: #444;
            --button-hover-bg: #555;
            --water-color-opaque: hsl(230, 100%, 50%);
            --water-color-transparent: hsla(230, 100%, 50%, 0.75);
            --water-color: var(--water-color-transparent); /* Fallback/default */
            --button-active-bg: var(--water-color-opaque);
            --text-color: #f0f0f0;
            --border-color: #555;
            --selection-color: #ffffff;
            --sky-top: #3a7bd5;
            --sky-bottom: #a8d5e5;
            --grass-color: #6b8e23;
            --dirt-color: #8b4513;
            --stone-color: #696969;
        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #toolbar {
            padding: 8px;
            background-color: var(--toolbar-bg);
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            height: var(--toolbar-height);
            box-sizing: border-box;
            z-index: 10;
        }
        #toolbar button {
            width: 40px;
            height: 40px;
            padding: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            border-radius: 5px;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #toolbar button svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        #toolbar button:hover {
            background-color: var(--button-hover-bg);
        }
        #toolbar button.active {
            background-color: var(--button-active-bg);
            border-color: var(--button-active-bg);
        }
        .tool-group {
            display: flex;
            gap: 2px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 2px;
        }
        .tool-group button {
            border: none;
            width: 36px;
            height: 36px;
        }
        #toolbar-separator {
            flex-grow: 1;
        }
        #simulation-container {
            flex-grow: 1;
            width: 100%;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
            overflow: hidden; /* Важно для камеры */
            background: linear-gradient(to bottom, var(--sky-top), var(--sky-bottom));
        }

        #ground {
            position: absolute;
            top: 0; /* JS будет управлять transform */
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            z-index: 0;
            pointer-events: none;
        }
        .ground-layer {
            width: 100%;
        }
        #grass { background-color: var(--grass-color); height: 20px; }
        #dirt { background-color: var(--dirt-color); height: 50px; }
        #stone { background-color: var(--stone-color); height: 1000px; } /* Глубокий слой */

        #water-effect-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        #water-effect-container.liquid-effect-enabled {
            filter: blur(8px) contrast(25);
            mix-blend-mode: multiply;
        }
        
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Основной канвас для физики должен быть поверх эффекта воды */
        #simulation-container > canvas {
            z-index: 3;
        }

        .popup {
            position: absolute;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 15px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            min-width: 200px;
        }
        .popup-slider-container, .popup-color-container {
             display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            width: 100%;
        }
         .popup-slider-container .label-value {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .popup-toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #object-properties-panel .delete-button {
            background-color: #c0392b;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }
        #object-properties-panel .delete-button:hover {
            background-color: #e74c3c;
        }
        input[type="color"] {
            width: 100%;
            height: 30px;
            border: none;
            padding: 0;
            background: none;
        }

        #bottom-toolbar {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            background-color: var(--toolbar-bg);
            border-radius: 8px;
            display: flex;
            gap: 10px;
            z-index: 10;
            border: 1px solid var(--border-color);
        }
        #bottom-toolbar button {
            width: 40px;
            height: 40px;
            padding: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            color: var(--text-color);
            border-radius: 5px;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #bottom-toolbar button svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        #bottom-toolbar button:hover {
            background-color: var(--button-hover-bg);
        }

    </style>
<script type="importmap">
{
  "imports": {
    "matter-js": "https://aistudiocdn.com/matter-js@^0.20.0"
  }
}
</script>
</head>
<body>
    <div id="toolbar">
        <button id="move-btn" class="active" title="Переместить (физика)">
            <svg viewBox="0 0 24 24"><path d="M13,6V11H18V7.75L22.25,12L18,16.25V13H13V18H16.25L12,22.25L7.75,18H11V13H6V16.25L1.75,12L6,7.75V11H11V6H7.75L12,1.75L16.25,6H13Z"/></svg>
        </button>
        <button id="finger-btn" title="Палец (точно)">
            <svg viewBox="0 0 24 24"><path d="M19,13.5C19,13.09 19.34,12.75 19.75,12.75C20.16,12.75 20.5,13.09 20.5,13.5V18.5C20.5,18.91 20.16,19.25 19.75,19.25H18.5V13.5C18.5,12.39 18.06,11.5 17.15,11.13L15.9,10.65C15.9,10.65 16,3.5 16,3C16,2.45 15.55,2 15,2C14.45,2 14,2.45 14,3V11L10,12.5V3C10,2.45 9.55,2 9,2C8.45,2 8,2.45 8,3V12.5L4,11V4.5C4,3.67 3.33,3 2.5,3C1.67,3 1,3.67 1,4.5V14.2C1,18.9 6.2,22.03 8.5,22.03C12.53,22.03 14.5,20.5 14.5,20.5C14.5,20.5 16.53,22.03 20.5,22.03C21.05,22.03 21.5,21.58 21.5,21.03V13.5H19Z"/></svg>
        </button>
        <div class="tool-group">
            <button id="box-btn" title="Коробка">
                <svg viewBox="0 0 24 24"><path d="M3,3H21V21H3V3M5,5V19H19V5H5Z"/></svg>
            </button>
            <button id="polygon-btn" title="Полигон">
                <svg viewBox="0 0 24 24"><path d="M14.5,3L16.5,5H13V3H14.5M19,3H17V5H21V9H19V11H21V15H19V17H21V21H5V11H7V9H5V5H9V3H11V5H7V7H9V9H11V7H13V5H11V3H12.5L11,1.5L9.5,3H5C3.89,3 3,3.89 3,5V21C3,22.11 3.89,23 5,23H21C22.11,23 23,22.11 23,21V5C23,3.89 22.11,3 21,3H19Z"/></svg>
            </button>
            <button id="line-btn" title="Линия">
                <svg viewBox="0 0 24 24"><path d="M4,20C5.3,18.2 6.4,16.1 7.2,13.8C8.5,9.6 8.2,5.2 5.5,2L7,3.5C9,6.6 9.2,10.6 8,14.5C7.3,16.5 6.3,18.4 5,20.1L4,20M21,3.5L19.5,2C16.8,5.2 16.5,9.6 17.8,13.8C18.6,16.1 19.7,18.2 21,20L20,20.1C18.7,18.4 17.7,16.5 17,14.5C15.8,10.6 16,6.6 18,3.5L21,3.5Z" /></svg>
            </button>
            <button id="brush-btn" title="Кисть">
                <svg viewBox="0 0 24 24"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z" /></svg>
            </button>
             <button id="water-btn" title="Вода">
                <svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69zM12 0L4.81 7.19a10 10 0 1 0 14.38 0L12 0z"/></svg>
            </button>
        </div>
        <button id="eraser-btn" title="Ластик">
            <svg viewBox="0 0 24 24"><path d="M16.24,3.56L20.44,7.76L18.33,9.88L14.13,5.67L16.24,3.56M4,14V18H8L17.5,8.5L13.5,4.5L4,14Z"/></svg>
        </button>
        <div id="toolbar-separator"></div>
        <button id="reward-btn" title="Получить награду">
            <svg viewBox="0 0 24 24"><path d="M12,2.6L9,4.72V7.5L12,9.65L15,7.5V4.72L12,2.6M18.5,6.22L12,10.5L5.5,6.22V16.72L12,21.05L18.5,16.72V6.22M21,4.72V16.72C21,17.11 20.79,17.47 20.47,17.64L12.57,22.14C12.4,22.23 12.2,22.28 12,22.28C11.8,22.28 11.6,22.23 11.43,22.14L3.53,17.64C3.21,17.47 3,17.11 3,16.72V4.72C3,4.33 3.21,3.97 3.53,3.8L11.43,0.3C11.6,0.2 11.8,0.16 12,0.16C12.2,0.16 12.4,0.2 12.57,0.3L20.47,3.8C20.79,3.97 21,4.33 21,4.72Z"/></svg>
        </button>
        <button id="settings-btn" title="Настройки">
            <svg viewBox="0 0 24 24"><path d="M19.43,12.98C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.98L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.98M12,15.5C10.07,15.5 8.5,13.93 8.5,12C8.5,10.07 10.07,8.5 12,8.5C13.93,8.5 15.5,10.07 15.5,12C15.5,13.93 13.93,15.5 12,15.5Z" /></svg>
        </button>
    </div>

    <div id="simulation-container">
        <div id="ground">
            <div class="ground-layer" id="grass"></div>
            <div class="ground-layer" id="dirt"></div>
            <div class="ground-layer" id="stone"></div>
        </div>
        <div id="water-effect-container">
            <canvas id="water-canvas"></canvas>
        </div>
    </div>
    
    <div id="bottom-toolbar">
        <button id="play-pause-btn" title="Воспроизвести">
            <svg id="play-icon" viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z" /></svg>
            <svg id="pause-icon" viewBox="0 0 24 24" style="display: none;"><path d="M14,19H18V5H14M6,19H10V5H6V19Z" /></svg>
        </button>
    </div>

    <div id="context-menu" class="popup">
        <div class="popup-slider-container">
             <div class="label-value">
                <label for="brush-size-slider">Толщина:</label>
                <span id="brush-size-value">10</span>
            </div>
            <input type="range" id="brush-size-slider" min="2" max="100" value="10">
        </div>
    </div>

    <div id="settings-panel" class="popup">
        <div class="popup-slider-container">
             <div class="label-value">
                <label for="gravity-slider">Гравитация:</label>
                <span id="gravity-value">1.0</span>
            </div>
            <input type="range" id="gravity-slider" min="-2" max="2" value="1" step="0.1">
        </div>
        <div class="popup-toggle-container">
            <label for="liquid-effect-toggle">Эффект жидкости:</label>
            <input type="checkbox" id="liquid-effect-toggle" checked>
        </div>
    </div>

    <div id="object-properties-panel" class="popup">
        <div class="popup-color-container">
            <label for="obj-color">Цвет</label>
            <input type="color" id="obj-color" value="#cccccc">
        </div>
        <div class="popup-slider-container">
            <div class="label-value"><label>Трение:</label><span id="obj-friction-value">0.1</span></div>
            <input type="range" id="obj-friction" min="0" max="1" step="0.05" value="0.1">
        </div>
         <div class="popup-slider-container">
            <div class="label-value"><label>Упругость:</label><span id="obj-restitution-value">0.1</span></div>
            <input type="range" id="obj-restitution" min="0" max="1" step="0.05" value="0.1">
        </div>
         <div class="popup-slider-container">
            <div class="label-value"><label>Плотность:</label><span id="obj-density-value">0.001</span></div>
            <input type="range" id="obj-density" min="0.0001" max="0.01" step="0.0001" value="0.001">
        </div>
        <div class="popup-toggle-container">
            <label for="obj-static">Неподвижный</label>
            <input type="checkbox" id="obj-static">
        </div>
        <button id="delete-selected-btn" class="delete-button">Удалить</button>
    </div>
    
    <script type="module" src="./index.js"></script>
</body>
</html>